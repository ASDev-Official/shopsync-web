{% set class = "md-nav__item" %}
{% if nav_item.active %}
  {% set class = "md-nav__item md-nav__item--active" %}
{% endif %}
{% if nav_item.children %}
  {% set class = class ~ " md-nav__item--nested" %}
{% endif %}

<li class="{{ class }}">
  {% set is_top_level = (level | default(1)) <= 1 %}
  
  {% if nav_item.children %}
    <!-- Section with children -->
    <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="{{ path }}" {% if nav_item.active %}checked{% endif %}>
    
    {% if is_top_level %}
      <!-- Top level section -->
      <label class="md-nav__link md-nav__link--section" for="{{ path }}" id="{{ path }}_label" tabindex="0">
        {% if nav_item.icon %}
          <span class="md-nav__icon md-icon"></span>
        {% endif %}
        <span class="md-ellipsis">
          {{ nav_item.title }}
        </span>
        <span class="md-nav__icon md-icon"></span>
      </label>
    {% else %}
      <!-- Nested section -->
      <label class="md-nav__link" for="{{ path }}" id="{{ path }}_label" tabindex="0">
        <span class="md-ellipsis">
          {{ nav_item.title }}
        </span>
        <span class="md-nav__icon md-icon"></span>
      </label>
    {% endif %}

    <nav class="md-nav" data-md-level="{{ level }}">
      <label class="md-nav__title" for="{{ path }}">
        <span class="md-nav__icon md-icon"></span>
        {{ nav_item.title }}
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        {% for nav_item in nav_item.children %}
          {% if not nav_item.children or nav_item.active %}
            {% set path = path ~ "_" ~ loop.index %}
            {% set level = level + 1 %}
            {% include "partials/nav-item.html" %}
          {% endif %}
        {% endfor %}
      </ul>
    </nav>
  {% else %}
    <!-- Single page link -->
    {% set toc = nav_item.toc %}
    {% if is_top_level %}
      <a href="{{ nav_item.url | url }}" class="md-nav__link md-nav__link--index">
        {% if nav_item.icon %}
          <span class="md-nav__icon md-icon"></span>
        {% endif %}
        <span class="md-ellipsis">
          {{ nav_item.title }}
        </span>
      </a>
    {% else %}
      <a href="{{ nav_item.url | url }}" class="md-nav__link">
        <span class="md-ellipsis">
          {{ nav_item.title }}
        </span>
      </a>
    {% endif %}

    {% if toc | first is defined and is_top_level %}
      <nav class="md-nav" data-md-level="{{ level }}">
        <label class="md-nav__title" for="{{ path }}">
          <span class="md-nav__icon md-icon"></span>
          {{ nav_item.title }}
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          {% for toc_item in toc %}
            <li class="md-nav__item">
              <a href="{{ toc_item.url | url }}" class="md-nav__link">
                {{ toc_item.title }}
              </a>
            </li>
          {% endfor %}
        </ul>
      </nav>
    {% endif %}
  {% endif %}
</li>
